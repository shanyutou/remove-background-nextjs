# ç¬¬å››é˜¶æ®µï¼šAI æ¨ç†æ ¸å¿ƒ

æœ¬é˜¶æ®µæ·±å…¥ç†è§£æµè§ˆå™¨ç«¯ AI æ¨ç†çš„åº•å±‚åŸç†ï¼ŒåŒ…æ‹¬ Transformers.js æ¶æ„ã€ONNX Runtime Web æ‰§è¡Œæœºåˆ¶ã€æ•°æ®è½¬æ¢æµç¨‹å’Œ RMBG-1.4 æ¨¡å‹åŸç†ã€‚

## ç›®å½•

1. [æµè§ˆå™¨ç«¯ AI æŠ€æœ¯æ ˆ](#1-æµè§ˆå™¨ç«¯-ai-æŠ€æœ¯æ ˆ)
2. [Transformers.js æ¶æ„](#2-transformersjs-æ¶æ„)
3. [ONNX Runtime Web æ‰§è¡Œæœºåˆ¶](#3-onnx-runtime-web-æ‰§è¡Œæœºåˆ¶)
4. [æ¨¡å‹åŠ è½½æµç¨‹è¯¦è§£](#4-æ¨¡å‹åŠ è½½æµç¨‹è¯¦è§£)
5. [æ•°æ®è½¬æ¢æµç¨‹](#5-æ•°æ®è½¬æ¢æµç¨‹)
6. [RMBG-1.4 æ¨¡å‹åŸç†](#6-rmbg-14-æ¨¡å‹åŸç†)
7. [Mask åº”ç”¨ä¸ Alpha é€šé“](#7-mask-åº”ç”¨ä¸-alpha-é€šé“)
8. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#8-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## 1. æµè§ˆå™¨ç«¯ AI æŠ€æœ¯æ ˆ

### æŠ€æœ¯æ ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä½ çš„åº”ç”¨ä»£ç                                 â”‚
â”‚              removeBackground(), getSegmenter()                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Transformers.js                              â”‚
â”‚           @huggingface/transformers (é«˜çº§ API)                  â”‚
â”‚        pipeline(), AutoModel, AutoProcessor                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ONNX Runtime Web                              â”‚
â”‚              onnxruntime-web (æ¨ç†å¼•æ“)                          â”‚
â”‚         InferenceSession, Tensor, run()                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    WebAssembly (WASM)                           â”‚
â”‚              é«˜æ€§èƒ½è®¡ç®—æ‰§è¡Œç¯å¢ƒ                                   â”‚
â”‚         æ¥è¿‘åŸç”Ÿé€Ÿåº¦ï¼Œè·¨æµè§ˆå™¨å…¼å®¹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      æµè§ˆå™¨ API                                  â”‚
â”‚     Canvas API, IndexedDB (ç¼“å­˜), Web Workers (å¯é€‰)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„å±‚èŒè´£

| å±‚çº§ | æŠ€æœ¯ | èŒè´£ |
|------|------|------|
| åº”ç”¨å±‚ | ä½ çš„ä»£ç  | ä¸šåŠ¡é€»è¾‘ã€UI äº¤äº’ |
| æ¡†æ¶å±‚ | Transformers.js | æ¨¡å‹åŠ è½½ã€é¢„å¤„ç†ã€åå¤„ç†ã€é«˜çº§ API |
| å¼•æ“å±‚ | ONNX Runtime Web | ç¥ç»ç½‘ç»œæ¨ç†æ‰§è¡Œ |
| æ‰§è¡Œå±‚ | WebAssembly | é«˜æ€§èƒ½è®¡ç®— |
| æµè§ˆå™¨å±‚ | Canvas/IndexedDB | å›¾åƒå¤„ç†ã€æ•°æ®å­˜å‚¨ |

---

## 2. Transformers.js æ¶æ„

### ä»€ä¹ˆæ˜¯ Transformers.js

Transformers.js æ˜¯ Hugging Face å®˜æ–¹çš„ JavaScript åº“ï¼Œå°† Python ç”Ÿæ€çš„ AI æ¨¡å‹å¸¦åˆ°æµè§ˆå™¨ç«¯ã€‚

```
Python ç”Ÿæ€                           JavaScript ç”Ÿæ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ transformers â”‚   ONNX è½¬æ¢          â”‚Transformers.jsâ”‚
â”‚   (Python)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  (Browser)    â”‚
â”‚              â”‚                     â”‚               â”‚
â”‚ PyTorch æ¨¡å‹ â”‚                     â”‚ ONNX æ¨¡å‹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pipeline API

Pipeline æ˜¯æœ€é«˜çº§çš„æŠ½è±¡ï¼Œä¸€è¡Œä»£ç å®Œæˆå¤æ‚ä»»åŠ¡ï¼š

```typescript
import { pipeline } from '@huggingface/transformers'

// åˆ›å»º pipeline
const segmenter = await pipeline(
  'image-segmentation',     // ä»»åŠ¡ç±»å‹
  'briaai/RMBG-1.4',        // æ¨¡å‹ ID
  { device: 'wasm' }        // æ‰§è¡Œè®¾å¤‡
)

// ä½¿ç”¨ pipelineï¼ˆè‡ªåŠ¨å¤„ç†é¢„å¤„ç†å’Œåå¤„ç†ï¼‰
const result = await segmenter(imageDataUrl)
```

### Pipeline å†…éƒ¨æµç¨‹

```
pipeline() å†…éƒ¨æ‰§è¡Œæµç¨‹ï¼š

è¾“å…¥: imageDataUrl (base64 æˆ– URL)
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1. å›¾åƒè§£ç       â”‚  å°† base64/URL è½¬ä¸º ImageData
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   2. é¢„å¤„ç†        â”‚  å½’ä¸€åŒ–ã€è°ƒæ•´å°ºå¯¸ã€è½¬ Tensor
â”‚   (Processor)     â”‚  [H, W, 3] â†’ [1, 3, H, W]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   3. æ¨¡å‹æ¨ç†      â”‚  ONNX Runtime æ‰§è¡Œç¥ç»ç½‘ç»œ
â”‚   (Model)         â”‚  è¾“å…¥ Tensor â†’ è¾“å‡º Tensor
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   4. åå¤„ç†        â”‚  Tensor â†’ Mask/RawImage
â”‚   (Processor)     â”‚  åº”ç”¨é˜ˆå€¼ã€è°ƒæ•´å°ºå¯¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
è¾“å‡º: [{ score, label, mask: RawImage }]
```

### æ”¯æŒçš„ä»»åŠ¡ç±»å‹

| ä»»åŠ¡ | æè¿° | ç¤ºä¾‹æ¨¡å‹ |
|------|------|---------|
| `image-segmentation` | å›¾åƒåˆ†å‰² | RMBG-1.4, SAM |
| `object-detection` | ç›®æ ‡æ£€æµ‹ | DETR, YOLO |
| `image-classification` | å›¾åƒåˆ†ç±» | ViT, ResNet |
| `text-generation` | æ–‡æœ¬ç”Ÿæˆ | GPT-2, LLaMA |
| `fill-mask` | å¡«å……æ©ç  | BERT |
| `translation` | ç¿»è¯‘ | T5, MarianMT |

---

## 3. ONNX Runtime Web æ‰§è¡Œæœºåˆ¶

### ä»€ä¹ˆæ˜¯ ONNX

ONNX (Open Neural Network Exchange) æ˜¯ä¸€ç§å¼€æ”¾çš„ç¥ç»ç½‘ç»œäº¤æ¢æ ¼å¼ï¼š

```
PyTorch/TensorFlow æ¨¡å‹
        â”‚
        â†“ å¯¼å‡º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   .onnx æ–‡ä»¶   â”‚  åŒ…å«ï¼š
â”‚               â”‚  - ç½‘ç»œç»“æ„ï¼ˆè®¡ç®—å›¾ï¼‰
â”‚               â”‚  - æƒé‡å‚æ•°
â”‚               â”‚  - è¾“å…¥/è¾“å‡ºè§„æ ¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“ åŠ è½½
ONNX Runtime (å„å¹³å°)
â”œâ”€â”€ onnxruntime (Python/C++)
â”œâ”€â”€ onnxruntime-node (Node.js)
â””â”€â”€ onnxruntime-web (Browser) â† æœ¬é¡¹ç›®ä½¿ç”¨
```

### ONNX Runtime Web åç«¯é€‰é¡¹

```typescript
// é¡¹ç›®é…ç½®
{ device: 'wasm' }  // ä½¿ç”¨ WebAssembly åç«¯
```

| åç«¯ | è¯´æ˜ | æ€§èƒ½ | å…¼å®¹æ€§ |
|------|------|------|--------|
| `wasm` | WebAssembly | ä¸­ç­‰ | â­â­â­ æœ€ä½³ |
| `webgl` | WebGL ç€è‰²å™¨ | è¾ƒå¿« | â­â­ éœ€è¦ GPU |
| `webgpu` | WebGPU (æ–°) | æœ€å¿« | â­ å®éªŒæ€§ |
| `cpu` | çº¯ JS (fallback) | æœ€æ…¢ | â­â­â­ |

### WASM æ‰§è¡Œæµç¨‹

```
JavaScript è°ƒç”¨
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ONNX Runtime Web API        â”‚
â”‚   session.run(inputTensors)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     WebAssembly æ¨¡å—             â”‚
â”‚   ort-wasm-simd.wasm            â”‚  ~2MB
â”‚   (ç¼–è¯‘è‡ª C++ ONNX Runtime)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æµè§ˆå™¨ WASM è™šæ‹Ÿæœº           â”‚
â”‚   æ¥è¿‘åŸç”Ÿ C++ æ‰§è¡Œé€Ÿåº¦          â”‚
â”‚   æ”¯æŒ SIMD æŒ‡ä»¤åŠ é€Ÿ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SIMD åŠ é€Ÿ

SIMD (Single Instruction Multiple Data) å…è®¸ä¸€æ¡æŒ‡ä»¤å¤„ç†å¤šä¸ªæ•°æ®ï¼š

```
ä¼ ç»Ÿæ‰§è¡Œï¼š
[a1] + [b1] = [c1]
[a2] + [b2] = [c2]    4 æ¡æŒ‡ä»¤
[a3] + [b3] = [c3]
[a4] + [b4] = [c4]

SIMD æ‰§è¡Œï¼š
[a1, a2, a3, a4] + [b1, b2, b3, b4] = [c1, c2, c3, c4]   1 æ¡æŒ‡ä»¤
```

æµè§ˆå™¨æ”¯æŒæƒ…å†µï¼š
- Chrome 91+: âœ… SIMD é»˜è®¤å¯ç”¨
- Firefox 89+: âœ… SIMD é»˜è®¤å¯ç”¨
- Safari 16.4+: âœ… SIMD æ”¯æŒ
- Edge 91+: âœ… SIMD é»˜è®¤å¯ç”¨

---

## 4. æ¨¡å‹åŠ è½½æµç¨‹è¯¦è§£

### åŠ è½½æ­¥éª¤åˆ†è§£

```typescript
// modelLoader.ts
const segmenter = await pipeline(
  'image-segmentation',
  'briaai/RMBG-1.4',
  {
    device: 'wasm',
    progress_callback: onProgress,
  }
)
```

**å†…éƒ¨åŠ è½½æ­¥éª¤**ï¼š

```
æ­¥éª¤ 1: è§£ææ¨¡å‹ ID
briaai/RMBG-1.4
   â†“
https://huggingface.co/briaai/RMBG-1.4

æ­¥éª¤ 2: ä¸‹è½½é…ç½®æ–‡ä»¶
â”œâ”€â”€ config.json          (æ¨¡å‹é…ç½®)
â”œâ”€â”€ preprocessor_config.json (é¢„å¤„ç†é…ç½®)
â””â”€â”€ tokenizer_config.json (å¦‚éœ€è¦)

æ­¥éª¤ 3: ä¸‹è½½ ONNX æ¨¡å‹æ–‡ä»¶
â””â”€â”€ onnx/model.onnx      (~176MB for RMBG-1.4)
    æˆ– model_quantized.onnx (é‡åŒ–ç‰ˆï¼Œæ›´å°)

æ­¥éª¤ 4: ä¸‹è½½ WASM è¿è¡Œæ—¶
â”œâ”€â”€ ort-wasm.wasm
â”œâ”€â”€ ort-wasm-simd.wasm   (SIMD åŠ é€Ÿç‰ˆ)
â””â”€â”€ ort-wasm-threaded.wasm (å¤šçº¿ç¨‹ç‰ˆ)

æ­¥éª¤ 5: åˆå§‹åŒ– ONNX Session
InferenceSession.create(modelBuffer)

æ­¥éª¤ 6: è¿”å› Pipeline å®ä¾‹
```

### è¿›åº¦å›è°ƒè¯¦è§£

```typescript
interface ProgressInfo {
  status: 'initiate' | 'download' | 'progress' | 'done' | 'ready'
  name?: string      // æ–‡ä»¶å
  file?: string      // å®Œæ•´è·¯å¾„
  progress?: number  // 0-100
  loaded?: number    // å·²ä¸‹è½½å­—èŠ‚
  total?: number     // æ€»å­—èŠ‚
}

// å›è°ƒæ—¶åº
{ status: 'initiate' }                           // å¼€å§‹
{ status: 'download', file: 'config.json' }      // ä¸‹è½½é…ç½®
{ status: 'progress', loaded: 50MB, total: 176MB } // ä¸‹è½½æ¨¡å‹
{ status: 'done', file: 'model.onnx' }           // æ–‡ä»¶å®Œæˆ
{ status: 'ready' }                              // å…¨éƒ¨å°±ç»ª
```

### ç¼“å­˜æœºåˆ¶

```typescript
// Transformers.js é…ç½®
transformers.env.useBrowserCache = true  // å¯ç”¨ IndexedDB ç¼“å­˜
```

**ç¼“å­˜å­˜å‚¨ä½ç½®**ï¼š

```
æµè§ˆå™¨ IndexedDB
â””â”€â”€ transformers-cache
    â”œâ”€â”€ briaai/RMBG-1.4/
    â”‚   â”œâ”€â”€ config.json
    â”‚   â”œâ”€â”€ preprocessor_config.json
    â”‚   â””â”€â”€ onnx/model.onnx (176MB)
    â””â”€â”€ ort-wasm-simd.wasm
```

**ç¼“å­˜æ•ˆæœ**ï¼š

| åœºæ™¯ | åŠ è½½æ—¶é—´ | ç½‘ç»œè¯·æ±‚ |
|------|---------|---------|
| é¦–æ¬¡åŠ è½½ | 5-30ç§’ | ~180MB |
| ç¼“å­˜åŠ è½½ | <1ç§’ | 0 |

### å•ä¾‹æ¨¡å¼å®ç°

```typescript
// ä¸ºä»€ä¹ˆä½¿ç”¨å•ä¾‹ï¼Ÿ
// 1. æ¨¡å‹å¾ˆå¤§ï¼ˆ176MBï¼‰ï¼Œä¸åº”é‡å¤åŠ è½½
// 2. åˆå§‹åŒ–è€—æ—¶ï¼Œåº”å¤ç”¨å®ä¾‹
// 3. é¿å…å†…å­˜æµªè´¹

let segmenterInstance: any = null
let loadingPromise: Promise<any> | null = null

export async function getSegmenter(): Promise<any> {
  // å·²åŠ è½½ â†’ ç›´æ¥è¿”å›
  if (segmenterInstance) {
    return segmenterInstance
  }

  // æ­£åœ¨åŠ è½½ â†’ è¿”å›åŒä¸€ä¸ª Promiseï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
  if (loadingPromise) {
    return loadingPromise
  }

  // é¦–æ¬¡åŠ è½½
  loadingPromise = initializeModel()
  segmenterInstance = await loadingPromise
  return segmenterInstance
}
```

**å¹¶å‘è¯·æ±‚å¤„ç†**ï¼š

```
è¯·æ±‚ 1: getSegmenter() â”€â”€â”€â”€â”€â†’ åˆ›å»º loadingPromise â”€â”€â”€â”€â”€â†’ ç­‰å¾…...
è¯·æ±‚ 2: getSegmenter() â”€â”€â”€â”€â”€â†’ è¿”å›åŒä¸€ä¸ª loadingPromise â”€â†’ ç­‰å¾…...
è¯·æ±‚ 3: getSegmenter() â”€â”€â”€â”€â”€â†’ è¿”å›åŒä¸€ä¸ª loadingPromise â”€â†’ ç­‰å¾…...
                                      â”‚
                                      â†“ åŠ è½½å®Œæˆ
                              æ‰€æœ‰è¯·æ±‚åŒæ—¶ resolve
```

---

## 5. æ•°æ®è½¬æ¢æµç¨‹

### å®Œæ•´æ•°æ®æµ

```
File (ç”¨æˆ·ä¸Šä¼ )
    â”‚
    â†“ loadImage()
HTMLImageElement
    â”‚
    â†“ drawImage()
Canvas (1024Ã—1024)
    â”‚
    â†“ toDataURL()
Base64 å­—ç¬¦ä¸² "data:image/png;base64,..."
    â”‚
    â†“ Transformers.js è§£ç 
ImageData { data: Uint8ClampedArray, width, height }
    â”‚
    â†“ é¢„å¤„ç† (normalize, transpose)
Tensor [1, 3, 1024, 1024] Float32Array
    â”‚
    â†“ ONNX Runtime æ¨ç†
Tensor [1, 1, 1024, 1024] Float32Array (mask)
    â”‚
    â†“ åå¤„ç†
RawImage { data, width, height }
    â”‚
    â†“ toCanvas()
Canvas (mask)
    â”‚
    â†“ getImageData()
Uint8Array (mask values 0-255)
    â”‚
    â†“ åº”ç”¨åˆ° Alpha é€šé“
Canvas (é€æ˜èƒŒæ™¯ç»“æœ)
    â”‚
    â†“ toDataURL() / toBlob()
è¾“å‡º (é¢„è§ˆ / ä¸‹è½½)
```

### ImageData ç»“æ„

```typescript
// Canvas getImageData() è¿”å›çš„ç»“æ„
interface ImageData {
  data: Uint8ClampedArray  // RGBA åƒç´ æ•°æ®
  width: number
  height: number
}

// data æ•°ç»„ç»“æ„ (æ¯ 4 ä¸ªå€¼ä»£è¡¨ä¸€ä¸ªåƒç´ )
// [R, G, B, A, R, G, B, A, R, G, B, A, ...]
//  â””â”€åƒç´ 1â”€â”˜  â””â”€åƒç´ 2â”€â”˜  â””â”€åƒç´ 3â”€â”˜

// ç¤ºä¾‹ï¼š3Ã—2 å›¾åƒ (6 åƒç´ )
data = [
  255, 0, 0, 255,    // åƒç´ (0,0): çº¢è‰²ï¼Œä¸é€æ˜
  0, 255, 0, 255,    // åƒç´ (1,0): ç»¿è‰²ï¼Œä¸é€æ˜
  0, 0, 255, 255,    // åƒç´ (2,0): è“è‰²ï¼Œä¸é€æ˜
  255, 255, 0, 128,  // åƒç´ (0,1): é»„è‰²ï¼ŒåŠé€æ˜
  0, 255, 255, 128,  // åƒç´ (1,1): é’è‰²ï¼ŒåŠé€æ˜
  255, 0, 255, 0,    // åƒç´ (2,1): ç´«è‰²ï¼Œå®Œå…¨é€æ˜
]
```

### Tensor ç»“æ„

```typescript
// ONNX Runtime Tensor
interface Tensor {
  data: Float32Array | Int32Array | ...
  dims: number[]  // ç»´åº¦ [batch, channels, height, width]
  type: string    // æ•°æ®ç±»å‹
}

// å›¾åƒè¾“å…¥ Tensor (NCHW æ ¼å¼)
dims = [1, 3, 1024, 1024]
//      â”‚  â”‚   â”‚     â”‚
//      â”‚  â”‚   â”‚     â””â”€ Width
//      â”‚  â”‚   â””â”€ Height
//      â”‚  â””â”€ Channels (RGB)
//      â””â”€ Batch size

// æ•°æ®æ’åˆ— (CHW é¡ºåºï¼Œé HWC)
data = [
  // Channel 0 (Red): æ‰€æœ‰åƒç´ çš„çº¢è‰²å€¼
  r(0,0), r(1,0), r(2,0), ..., r(1023,1023),
  // Channel 1 (Green): æ‰€æœ‰åƒç´ çš„ç»¿è‰²å€¼
  g(0,0), g(1,0), g(2,0), ..., g(1023,1023),
  // Channel 2 (Blue): æ‰€æœ‰åƒç´ çš„è“è‰²å€¼
  b(0,0), b(1,0), b(2,0), ..., b(1023,1023),
]
```

### é¢„å¤„ç†ï¼šHWC â†’ NCHW è½¬æ¢

```typescript
// è¾“å…¥: ImageData (HWC æ ¼å¼)
// [R,G,B,A, R,G,B,A, ...] - åƒç´ é¡ºåºæ’åˆ—

// è¾“å‡º: Tensor (NCHW æ ¼å¼)
// [æ‰€æœ‰R, æ‰€æœ‰G, æ‰€æœ‰B] - é€šé“åˆ†ç¦»

function imageDataToTensor(imageData: ImageData): Float32Array {
  const { data, width, height } = imageData
  const channels = 3
  const tensor = new Float32Array(channels * width * height)

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const pixelIndex = (y * width + x) * 4  // ImageData ä¸­çš„ä½ç½®
      const tensorIndexBase = y * width + x    // Tensor ä¸­çš„ä½ç½®

      // å½’ä¸€åŒ– (0-255 â†’ 0-1) å¹¶åˆ†ç¦»é€šé“
      tensor[0 * width * height + tensorIndexBase] = data[pixelIndex + 0] / 255  // R
      tensor[1 * width * height + tensorIndexBase] = data[pixelIndex + 1] / 255  // G
      tensor[2 * width * height + tensorIndexBase] = data[pixelIndex + 2] / 255  // B
    }
  }

  return tensor
}
```

**å›¾è§£**ï¼š

```
ImageData (HWC)                    Tensor (NCHW)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ R G B A â”‚ R G B A â”‚              â”‚ R R R R R R R ... â”‚ Channel 0
â”‚ R G B A â”‚ R G B A â”‚    è½¬æ¢      â”‚ G G G G G G G ... â”‚ Channel 1
â”‚ R G B A â”‚ R G B A â”‚  â”€â”€â”€â”€â”€â”€â”€â†’    â”‚ B B B B B B B ... â”‚ Channel 2
â”‚   ...   â”‚   ...   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   åƒç´ é¡ºåºæ’åˆ—                        é€šé“åˆ†ç¦»æ’åˆ—
```

---

## 6. RMBG-1.4 æ¨¡å‹åŸç†

### æ¨¡å‹ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| åç§° | RMBG-1.4 (Remove Background) |
| å¼€å‘è€… | BRIA AI |
| æ¶æ„ | IS-Net (Intermediate Supervision Network) |
| å‚æ•°é‡ | 44.1M |
| è¾“å…¥å°ºå¯¸ | 1024Ã—1024 |
| è¾“å‡º | å•é€šé“ mask (å‰æ™¯æ¦‚ç‡) |
| æ¨¡å‹å¤§å° | ~176MB (ONNX) |

### IS-Net æ¶æ„

```
IS-Net (Intermediate Supervision Network)

è¾“å…¥å›¾åƒ [1, 3, 1024, 1024]
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Encoder (ç¼–ç å™¨)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ E1  â”‚ â†’ â”‚ E2  â”‚ â†’ â”‚ E3  â”‚ â†’ ...   â”‚ é€å±‚æå–ç‰¹å¾
â”‚  â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜         â”‚ åˆ†è¾¨ç‡é€æ¸é™ä½
â”‚     â†“         â†“         â†“             â”‚ ç‰¹å¾ç»´åº¦å¢åŠ 
â””â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚         â”‚         â”‚
      â†“         â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Intermediate Supervision         â”‚
â”‚   æ¯å±‚éƒ½äº§ç”Ÿä¸€ä¸ª mask é¢„æµ‹ç”¨äºç›‘ç£å­¦ä¹     â”‚
â”‚   (IS-Net çš„æ ¸å¿ƒåˆ›æ–°)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚         â”‚         â”‚
      â†“         â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Decoder (è§£ç å™¨)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ D1  â”‚ â† â”‚ D2  â”‚ â† â”‚ D3  â”‚ â† ...   â”‚ é€å±‚ä¸Šé‡‡æ ·
â”‚  â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜         â”‚ æ¢å¤åŸå§‹åˆ†è¾¨ç‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
è¾“å‡º mask [1, 1, 1024, 1024]
```

### ä¸­é—´ç›‘ç£çš„ä¼˜åŠ¿

ä¼ ç»Ÿåˆ†å‰²ç½‘ç»œåªåœ¨æœ€ç»ˆè¾“å‡ºè¿›è¡Œç›‘ç£ï¼Œè€Œ IS-Net åœ¨æ¯ä¸€å±‚éƒ½è¿›è¡Œç›‘ç£ï¼š

```
ä¼ ç»Ÿç½‘ç»œ:
Encoder â†’ Decoder â†’ å•ä¸€æŸå¤±å‡½æ•°
                         â†‘
                    åªåœ¨è¿™é‡Œå­¦ä¹ 

IS-Net:
Encoder â†’ Decoder
   â†“         â†“
 Loss1    Loss2    Loss3 ... LossN
   â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â†“
           è”åˆæŸå¤±å‡½æ•°

ä¼˜åŠ¿:
1. æ¢¯åº¦æ›´å¥½åœ°ä¼ æ’­åˆ°æµ…å±‚
2. æ¯å±‚éƒ½å­¦ä¹ æœ‰æ„ä¹‰çš„ç‰¹å¾
3. è¾¹ç¼˜ç»†èŠ‚æ›´æ¸…æ™°
```

### æ¨¡å‹è¾“å‡ºè§£è¯»

```typescript
// RMBG-1.4 è¾“å‡º
result = [
  {
    score: 0.99,           // ç½®ä¿¡åº¦
    label: 'foreground',   // æ ‡ç­¾
    mask: RawImage {       // ğŸ”‘ å…³é”®ï¼šå‰æ™¯ mask
      data: Float32Array,  // å€¼èŒƒå›´ 0-1
      width: 1024,
      height: 1024,
      channels: 1
    }
  }
]

// mask å€¼å«ä¹‰
0.0 = èƒŒæ™¯ (å®Œå…¨é€æ˜)
0.5 = è¾¹ç¼˜ (åŠé€æ˜)
1.0 = å‰æ™¯ (å®Œå…¨ä¸é€æ˜)
```

---

## 7. Mask åº”ç”¨ä¸ Alpha é€šé“

### Alpha é€šé“åŸºç¡€

```
RGBA é¢œè‰²æ¨¡å‹:
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  R  â”‚  G  â”‚  B  â”‚  A  â”‚
â”‚ çº¢  â”‚ ç»¿  â”‚ è“  â”‚é€æ˜åº¦â”‚
â”‚0-255â”‚0-255â”‚0-255â”‚0-255â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

Alpha å€¼å«ä¹‰:
  0   = å®Œå…¨é€æ˜ (ä¸å¯è§)
  128 = åŠé€æ˜ (50%)
  255 = å®Œå…¨ä¸é€æ˜
```

### Mask åº”ç”¨ç®—æ³•

```typescript
// removeBackground.ts - applySegmentationMask

async function applySegmentationMask(canvas, ctx, segmentationResult) {
  // 1. è·å–åŸå§‹åƒç´ æ•°æ®
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
  const pixels = imageData.data  // [R,G,B,A, R,G,B,A, ...]

  // 2. æå– mask (æ¯ä¸ªåƒç´ ä¸€ä¸ªå€¼ï¼Œ0-255)
  const maskData = await extractMaskData(segmentationResult, canvas.width, canvas.height)

  // 3. å°† mask åº”ç”¨åˆ° Alpha é€šé“
  for (let i = 0; i < maskData.length; i++) {
    pixels[i * 4 + 3] = maskData[i]
    //     â†‘     â†‘
    //     â”‚     â””â”€ Alpha é€šé“åç§» (+3)
    //     â””â”€ åƒç´ ç´¢å¼• Ã— 4 (RGBA)
  }

  // 4. å†™å› Canvas
  ctx.putImageData(imageData, 0, 0)
}
```

**å›¾è§£**ï¼š

```
åƒç´ ç´¢å¼•:     0           1           2           3
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
pixels:    â”‚R G B A    â”‚R G B A    â”‚R G B A    â”‚R G B A    â”‚
           â”‚0 1 2 3    â”‚4 5 6 7    â”‚8 9 10 11  â”‚12 13 14 15â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†‘           â†‘           â†‘           â†‘
maskData:       [255,       128,         0,        255]
                 â”‚           â”‚           â”‚           â”‚
                 â†“           â†“           â†“           â†“
ç»“æœ:        ä¸é€æ˜       åŠé€æ˜      é€æ˜        ä¸é€æ˜
```

### Mask æ•°æ®æå–

æ¨¡å‹è¾“å‡ºæ ¼å¼å¯èƒ½ä¸åŒï¼Œéœ€è¦å¤„ç†å¤šç§æƒ…å†µï¼š

```typescript
async function extractMaskData(result, width, height): Promise<Uint8Array> {
  const maskData = new Uint8Array(width * height)

  // æƒ…å†µ 1: RawImage å¯¹è±¡ (æœ€å¸¸è§)
  if (segment.mask?.toCanvas) {
    const maskCanvas = mask.toCanvas()
    const maskCtx = maskCanvas.getContext('2d')
    const maskImageData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height)

    // ä»çº¢è‰²é€šé“æå– (mask æ˜¯ç°åº¦å›¾)
    for (let i = 0; i < totalPixels; i++) {
      maskData[i] = maskImageData.data[i * 4]  // R channel
    }
  }

  // æƒ…å†µ 2: ç›´æ¥æ•°ç»„æ•°æ®
  else if (mask.data) {
    for (let i = 0; i < totalPixels; i++) {
      const value = mask.data[i]
      // å¤„ç† 0-1 æˆ– 0-255 ä¸¤ç§èŒƒå›´
      maskData[i] = value <= 1 ? Math.round(value * 255) : Math.round(value)
    }
  }

  // æƒ…å†µ 3: éœ€è¦è°ƒæ•´å°ºå¯¸
  if (mask.width !== width || mask.height !== height) {
    return resizeMask(...)  // åŒçº¿æ€§æ’å€¼ç¼©æ”¾
  }

  return maskData
}
```

### Mask ç¼©æ”¾ç®—æ³•

```typescript
// æœ€è¿‘é‚»æ’å€¼ (ç®€å•ä½†è¾¹ç¼˜å¯èƒ½é”¯é½¿)
function resizeMask(data, srcW, srcH, dstW, dstH): Uint8Array {
  const result = new Uint8Array(dstW * dstH)
  const xRatio = srcW / dstW
  const yRatio = srcH / dstH

  for (let y = 0; y < dstH; y++) {
    for (let x = 0; x < dstW; x++) {
      // æ‰¾åˆ°æºå›¾ä¸­å¯¹åº”çš„ä½ç½®
      const srcX = Math.floor(x * xRatio)
      const srcY = Math.floor(y * yRatio)

      // å¤åˆ¶å€¼
      result[y * dstW + x] = data[srcY * srcW + srcX]
    }
  }

  return result
}
```

**ç¼©æ”¾å›¾è§£**ï¼š

```
æº Mask (4Ã—4)              ç›®æ ‡ Mask (8Ã—8)
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”          â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”
â”‚ A â”‚ B â”‚ C â”‚ D â”‚          â”‚Aâ”‚Aâ”‚Bâ”‚Bâ”‚Câ”‚Câ”‚Dâ”‚Dâ”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤   æ”¾å¤§   â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤
â”‚ E â”‚ F â”‚ G â”‚ H â”‚  â”€â”€â”€â”€â†’   â”‚Aâ”‚Aâ”‚Bâ”‚Bâ”‚Câ”‚Câ”‚Dâ”‚Dâ”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤          â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤
â”‚ I â”‚ J â”‚ K â”‚ L â”‚          â”‚Eâ”‚Eâ”‚Fâ”‚Fâ”‚Gâ”‚Gâ”‚Hâ”‚Hâ”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤          â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤
â”‚ M â”‚ N â”‚ O â”‚ P â”‚          â”‚Eâ”‚Eâ”‚Fâ”‚Fâ”‚Gâ”‚Gâ”‚Hâ”‚Hâ”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜          â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤
                           â”‚...ç»§ç»­...      â”‚
                           â””â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”˜
```

---

## 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### å½“å‰é¡¹ç›®é‡‡ç”¨çš„ä¼˜åŒ–

| ç­–ç•¥ | å®ç° | æ•ˆæœ |
|------|------|------|
| æ¨¡å‹ç¼“å­˜ | IndexedDB | åç»­åŠ è½½ <1ç§’ |
| å•ä¾‹æ¨¡å¼ | `segmenterInstance` | é¿å…é‡å¤åˆå§‹åŒ– |
| WASM + SIMD | `device: 'wasm'` | æ¥è¿‘åŸç”Ÿæ€§èƒ½ |
| å›ºå®šè¾“å…¥å°ºå¯¸ | 1024Ã—1024 | å¯é¢„æµ‹çš„å¤„ç†æ—¶é—´ |

### å¯é€‰çš„è¿›ä¸€æ­¥ä¼˜åŒ–

#### 1. é‡åŒ–æ¨¡å‹

```typescript
// ä½¿ç”¨é‡åŒ–ç‰ˆæœ¬ (æ›´å°ï¼Œæ›´å¿«ï¼Œç²¾åº¦ç•¥é™)
const segmenter = await pipeline(
  'image-segmentation',
  'briaai/RMBG-1.4',
  {
    quantized: true,  // ä½¿ç”¨ INT8 é‡åŒ–
    device: 'wasm',
  }
)

// æ¨¡å‹å¤§å°å¯¹æ¯”
// FP32: ~176MB
// INT8: ~44MB (çº¦ 1/4)
```

#### 2. Web Worker åå°å¤„ç†

```typescript
// worker.ts
import { pipeline } from '@huggingface/transformers'

let segmenter = null

self.onmessage = async (e) => {
  if (e.data.type === 'init') {
    segmenter = await pipeline('image-segmentation', 'briaai/RMBG-1.4')
    self.postMessage({ type: 'ready' })
  }

  if (e.data.type === 'process') {
    const result = await segmenter(e.data.imageUrl)
    self.postMessage({ type: 'result', data: result })
  }
}

// ä¸»çº¿ç¨‹
const worker = new Worker('worker.js')
worker.postMessage({ type: 'init' })
worker.onmessage = (e) => {
  if (e.data.type === 'result') {
    // å¤„ç†ç»“æœ
  }
}
```

#### 3. é¢„åŠ è½½æ¨¡å‹

```typescript
// é¡µé¢åŠ è½½æ—¶å¼€å§‹é¢„åŠ è½½ï¼Œä¸é˜»å¡ç”¨æˆ·
useEffect(() => {
  preloadModel((progress) => {
    console.log('Preloading:', progress.progress)
  })
}, [])
```

#### 4. æ¸è¿›å¼æ˜¾ç¤º

```typescript
// å…ˆæ˜¾ç¤ºä½åˆ†è¾¨ç‡ç»“æœï¼Œå†æ˜¾ç¤ºé«˜åˆ†è¾¨ç‡
async function progressiveProcess(file) {
  // å¿«é€Ÿé¢„è§ˆ (256Ã—256)
  const quickResult = await processAtSize(file, 256)
  setPreview(quickResult)  // ç«‹å³æ˜¾ç¤º

  // é«˜è´¨é‡ç»“æœ (1024Ã—1024)
  const fullResult = await processAtSize(file, 1024)
  setPreview(fullResult)   // æ›¿æ¢é¢„è§ˆ
}
```

### æ€§èƒ½åŸºå‡†

| æ“ä½œ | é¦–æ¬¡ | ç¼“å­˜å |
|------|------|--------|
| æ¨¡å‹ä¸‹è½½ | 5-30ç§’ | 0ç§’ |
| æ¨¡å‹åˆå§‹åŒ– | 2-3ç§’ | 0.5ç§’ |
| å›¾åƒæ¨ç† (1024Ã—1024) | 1-3ç§’ | 1-3ç§’ |
| åå¤„ç† | <0.1ç§’ | <0.1ç§’ |
| **æ€»è®¡** | **8-36ç§’** | **1.5-3.5ç§’** |

---

## ç†è§£æ£€æŸ¥ç‚¹

å®Œæˆæœ¬é˜¶æ®µå­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å›ç­”ï¼š

1. **Transformers.js çš„ pipeline API å†…éƒ¨åšäº†ä»€ä¹ˆï¼Ÿ**
   > è‡ªåŠ¨å¤„ç†å›¾åƒè§£ç ã€é¢„å¤„ç†ï¼ˆå½’ä¸€åŒ–ã€è½¬ Tensorï¼‰ã€æ¨¡å‹æ¨ç†ã€åå¤„ç†ï¼ˆTensor è½¬ RawImageï¼‰ã€‚

2. **ä¸ºä»€ä¹ˆä½¿ç”¨ WASM è€Œä¸æ˜¯ WebGLï¼Ÿ**
   > WASM å…¼å®¹æ€§æœ€å¥½ï¼Œä¸ä¾èµ– GPUï¼Œåœ¨æ‰€æœ‰ç°ä»£æµè§ˆå™¨ä¸­éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚WebGL è™½ç„¶æ›´å¿«ä½†å…¼å®¹æ€§å’Œç¨³å®šæ€§ä¸å¦‚ WASMã€‚

3. **ImageData çš„ HWC æ ¼å¼å’Œ Tensor çš„ NCHW æ ¼å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
   > HWC æ˜¯åƒç´ é¡ºåºæ’åˆ— `[R,G,B,A, R,G,B,A, ...]`ï¼ŒNCHW æ˜¯é€šé“åˆ†ç¦»æ’åˆ— `[æ‰€æœ‰R, æ‰€æœ‰G, æ‰€æœ‰B]`ã€‚é¢„å¤„ç†éœ€è¦è¿›è¡Œè½¬æ¢ã€‚

4. **IS-Net çš„"ä¸­é—´ç›‘ç£"æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**
   > åœ¨ç½‘ç»œçš„æ¯ä¸€å±‚éƒ½è®¡ç®—æŸå¤±å‡½æ•°è¿›è¡Œç›‘ç£å­¦ä¹ ï¼Œè€Œä¸æ˜¯åªåœ¨æœ€ç»ˆè¾“å‡ºã€‚è¿™ä½¿å¾—æµ…å±‚ä¹Ÿèƒ½å­¦ä¹ åˆ°æœ‰æ„ä¹‰çš„ç‰¹å¾ï¼Œè¾¹ç¼˜ç»†èŠ‚æ›´æ¸…æ™°ã€‚

5. **Mask å€¼æ˜¯å¦‚ä½•è½¬æ¢ä¸ºé€æ˜åº¦çš„ï¼Ÿ**
   > Mask å€¼ï¼ˆ0-1 æˆ– 0-255ï¼‰ç›´æ¥å†™å…¥å›¾åƒçš„ Alpha é€šé“ã€‚å€¼ä¸º 0 å®Œå…¨é€æ˜ï¼Œå€¼ä¸º 255 å®Œå…¨ä¸é€æ˜ï¼Œä¸­é—´å€¼äº§ç”ŸåŠé€æ˜æ•ˆæœã€‚

6. **ä¸ºä»€ä¹ˆæ¨¡å‹ä½¿ç”¨å•ä¾‹æ¨¡å¼åŠ è½½ï¼Ÿ**
   > æ¨¡å‹å¾ˆå¤§ï¼ˆ176MBï¼‰ï¼ŒåŠ è½½è€—æ—¶ï¼Œå•ä¾‹ç¡®ä¿åªåŠ è½½ä¸€æ¬¡ã€‚å¤šä¸ªè¯·æ±‚å…±äº«åŒä¸€ä¸ª loading Promiseï¼Œé¿å…é‡å¤ä¸‹è½½ã€‚

7. **IndexedDB ç¼“å­˜å¦‚ä½•å·¥ä½œï¼Ÿ**
   > Transformers.js å°†ä¸‹è½½çš„æ¨¡å‹æ–‡ä»¶å­˜å‚¨åœ¨æµè§ˆå™¨çš„ IndexedDB ä¸­ã€‚åç»­è®¿é—®æ—¶ç›´æ¥ä»æœ¬åœ°è¯»å–ï¼Œè·³è¿‡ç½‘ç»œä¸‹è½½ã€‚

---

## æ€»ç»“

æµè§ˆå™¨ç«¯ AI æ¨ç†çš„æ ¸å¿ƒé“¾è·¯ï¼š

```
ç”¨æˆ·å›¾åƒ â†’ Canvas â†’ Base64 â†’ Tensor (NCHW)
                                   â”‚
                                   â†“
                           ONNX Runtime (WASM)
                                   â”‚
                                   â†“
                            IS-Net ç¥ç»ç½‘ç»œ
                                   â”‚
                                   â†“
                          Mask Tensor (0-1)
                                   â”‚
                                   â†“
               Uint8Array (0-255) â†’ Alpha é€šé“ â†’ é€æ˜èƒŒæ™¯ PNG
```

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•åœ¨æµè§ˆå™¨ä¸­å®ç°å®Œæ•´çš„æ·±åº¦å­¦ä¹ æ¨ç†æµç¨‹ï¼ŒåŒæ—¶ä¿æŒç”¨æˆ·éšç§ï¼ˆæ•°æ®ä¸ç¦»å¼€è®¾å¤‡ï¼‰ã€‚
